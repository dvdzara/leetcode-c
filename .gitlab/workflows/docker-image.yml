docker-build:
  image: docker.io/library/docker:27.3.1-cli@sha256:6806d2764925d3b483f9732422b95321781765aeece274b4e60063d02e13efd6
  rules:
    - changes:
        - Dockerfile
      if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - echo $CI_REGISTRY_PASSWORD | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    - docker build -t $CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_SHA-$ARCH .
    - |
      for t in "latest" "$CI_COMMIT_TAG"; do
        docker tag $CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_SHA-$ARCH $CI_REGISTRY/$CI_PROJECT_PATH:$t
        docker push $CI_REGISTRY/$CI_PROJECT_PATH:$t
      done
  tags:
    - amd64

# yaml-language-server: $schema=https://raw.githubusercontent.com/woodpecker-ci/woodpecker/main/pipeline/frontend/yaml/linter/schema/schema.json

steps:
  - commands:
      - echo "deb https://apt.llvm.org/bookworm llvm-toolchain-bookworm-$CLANG_VERSION main" | tee /etc/apt/sources.list.d/llvm.list
      - curl "https://apt.llvm.org/llvm-snapshot.gpg.key" | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
      - apt-get update
      - apt-get install -y --no-install-recommends "clang-$CLANG_VERSION" "clang-tidy-$CLANG_VERSION" ninja-build
      - pip install --root-user-action=ignore "meson==$MESON_VERSION"
      - export CC="clang-$CLANG_VERSION"
      - export CXX="clang++-$CLANG_VERSION"
      - ln -s "/usr/bin/clang-tidy-$CLANG_VERSION" /usr/bin/clang-tidy
      - meson setup .build
      - ninja -C .build clang-tidy
    environment:
      CLANG_VERSION: 18
      # renovate: datasource=pypi depName=meson versioning=pep440
      MESON_VERSION: 1.5.2
    image: docker.io/library/python:3.13.0-bookworm@sha256:0eb8d3feda44654b7bc3e6e21dd19b793ce9eda75bbd0cf16a2407a1f0a4448b
    name: check-clang-tidy

when:
  - event: pull_request
